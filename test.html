<!DOCTYPE html>
<html style="height: 100%;">

<head>
    <title>Parcel Sandbox</title>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/jspdf@1.5.3/dist/jspdf.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.3/dist/jspdf.plugin.autotable.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!-- https://rawgit.com/MrRio/jsPDF/master/fontconverter/fontconverter.html -->
    <script type="text/javascript" src="roboto-normal.js"></script>
    <script type="text/javascript" src="roboto-italic.js"></script>
    <script type="text/javascript" src="roboto-bold.js"></script>
    <script type="text/javascript" src="roboto-bolditalic.js"></script>
    <!-- Logo en base 64 -->
    <script type="text/javascript" src="logoBase64.js"></script>
</head>

<body style="height: 100%;">
    <iframe frameborder="1" width="100%" height="100%"></iframe>
    <script>

        $(document).ready(function () {
            var pdf = new jsPDF("p", "mm", "a4");

            /* DATA */
            const TVA = 7.7;
            let totalData = {
                total: 0,
                subTotalSoftware: 0,
                subTotalService: 0
            };

            /* bill data */
            let bill = {
                id: 920030174,
                title: 'Migration messagerie locale vers Microsoft Office 365',
                dateStart: '17.03.2020',
                dateEnd: '16.04.2020',
                hourlyRate: 150,
                client: {
                    id: 216157,
                    name: 'Etude MCE Avocats',
                    street: 'Grand Chêne 1-3',
                    postal: 'case postale 6868',
                    city: '1002 Lausanne'
                },
                bank: {
                    name: 'Banque Contonale du Valais',
                    city: '1951 Sion'
                },
                lines: [
                    { description: 'Licence BitTitan MigrationWiz', type: 1, price: 20, quantity: 65, total: 1300 },
                    { description: 'Prémigration', type: 2, price: 150, quantity: 28, total: 4200 },
                    { description: '1Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '2Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '3Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '4Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '5Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '6Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '7Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '8Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '9Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '10Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '11Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '12Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '13Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '14Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '15Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '16Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '17Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '18Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '19Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: 'Postmigration', type: 2, price: 150, quantity: 16, total: 2400 }
                ],
                total: 432432
            };

            let cinfo = {
                name: 'C Informatique Sàrl',
                street: 'Route de Larret 19',
                city: '1870 Monthey',
                phone: '+41 24 550 56 00',
                mail: 'informatique@cinformatique.ch',
                web: 'www.cinformatique.ch'
            };

            let env = {
                font: 'roboto',
                theme: 'plain',
                marginLeft: 15
            };

            /* FUNCTIONS */
            //calculate total and subTotal
            function calculateTot() {
                for (let i = 0; i < bill.lines.length; i++) {
                    //total
                    totalData.total += bill.lines[i].price * bill.lines[i].quantity;

                    //subtotal
                    if (bill.lines[i].type == 1) {
                        totalData.subTotalSoftware += bill.lines[i].price * bill.lines[i].quantity;
                    }
                    if (bill.lines[i].type == 2) {
                        totalData.subTotalService += bill.lines[i].price * bill.lines[i].quantity;
                    }

                }
            };

            //currency format A FAIRE

            //generate header
            function getHeader() {
                //logo
                pdf.addImage(logoImg, "PNG", 15, 15, 71, 22);

                //info facture
                pdf.autoTable({
                    startY: 15,
                    theme: 'plain',
                    tableWidth: 'wrap',
                    margin: {
                        left: 155,
                    },
                    styles: {
                        font: 'roboto',
                        cellPadding: 0.5,
                        halign: 'right',
                    },
                    body: [
                        [{
                            content: "N° de facture",
                            colSpan: 2,
                            styles: {
                                textColor: '#999999',
                                fontStyle: 'bold'
                            }
                        }],
                        [{
                            content: bill.id,
                            colSpan: 2,
                            styles: {
                                fontStyle: 'bold',
                                textColor: '#1750a0'
                            }
                        }],
                        [{
                            content: "Date d'émission:"
                        }, {
                            content: bill.dateStart,
                            styles: {
                                fontStyle: 'bold',
                            }
                        }],
                        [{
                            content: "Échéance:"
                        }, {
                            content: bill.dateEnd,
                            styles: {
                                fontStyle: 'bold',
                            }
                        }],
                        [{
                            content: "CHE-631.761 TVA",
                            colSpan: 2
                        }]
                    ]
                });

                // Addresse client
                pdf.autoTable({
                    startY: 53,
                    theme: 'plain',
                    tableWidth: 'wrap',
                    margin: {
                        left: 22
                    },
                    styles: {
                        font: 'roboto',
                        cellPadding: 0.5,
                    },
                    body: [
                        [{
                            content: 'Adresse du client',
                            styles: {
                                fontStyle: 'bold'
                            }
                        }],
                        [{ content: bill.client.name }],
                        [{ content: bill.client.street }],
                        [{ content: bill.client.postal }],
                        [{ content: bill.client.city }]

                    ]
                });

                //numero client
                pdf.autoTable({
                    startY: 70,
                    theme: 'plain',
                    margin: {
                        left: 130,
                    },

                    styles: {
                        font: 'roboto',
                        textColor: '#999999',
                        //yellow box
                        fillColor: [255, 255, 224]
                    },
                    columnStyles: {
                        0: {
                            fontStyle: 'bold',
                        },
                        1: {
                            halign: 'right',
                        },
                    },
                    body: [
                        ['Numéro de client', bill.client.id]
                    ]
                });

            }

            //generate main data for body
            function generateData(billLineType, data) {
                bill.lines.forEach(i => {
                    if (i.type == billLineType) {
                        data.push([
                            {
                                content: i.description,
                                colSpan: 2,
                                styles: {
                                }
                            },
                            {
                                content: i.price.toFixed(2) + ' CHF',
                                styles: {
                                }
                            },
                            {
                                content: i.quantity.toFixed(2),
                                styles: {
                                }
                            },
                            {
                                content: i.total.toFixed(2) + ' CHF',
                                styles: {
                                }
                            }
                        ]);
                    }
                })
            }

            //main body data
            function getBody(idTable) {
                let body = [];

                if (idTable == 1) {
                    //title+header
                    body = [
                        //title
                        [{
                            content: 'Facture - ' + bill.title,
                            colSpan: 5,
                            styles: {
                                halign: 'center',
                                fontStyle: 'bold',
                                //gray box
                                fillColor: [192, 192, 192]
                            }
                        }],
                        //header
                        [{
                            content: 'Article',
                            styles: {
                                textColor: '#999999',
                                fontStyle: 'bold'
                            }
                        }, {
                            content: '',
                        },
                        {
                            content: 'Prix unitaire',
                            styles: {
                                textColor: '#999999',
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Quantité',
                            styles: {
                                textColor: '#999999',
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Montant Totale',
                            styles: {
                                textColor: '#999999',
                                fontStyle: 'bold'
                            }
                        }]
                    ];

                    //header 1st content
                    body.push([{
                        content: 'Logiciel',
                        colSpan: 5,
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            //soft gray box
                            fillColor: [220, 220, 220]
                        }
                    }]);
                    //1st content
                    generateData(1, body);
                    //1st subtotal
                    body.push([{
                        content: 'Sous total',
                        colSpan: 4,
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.subTotalSoftware.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);

                    //header 2nd content
                    body.push([{
                        content: 'Service',
                        colSpan: 5,
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            //soft gray box
                            fillColor: [220, 220, 220]
                        }
                    }]);
                    //2nd content
                    generateData(2, body);
                    //2nd subtotal
                    body.push([{
                        content: 'Sous total',
                        colSpan: 4,
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.subTotalService.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: 'Facture ' + bill.id + ': ' + bill.title,
                        colSpan: 5,
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            //soft gray box
                            fillColor: [220, 220, 220]
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 5
                    }]);

                    //total box
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'SOUS-TOTAL',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.total.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        //yellow box
                        content: 'Tarif horaire hors TVA: ',
                        styles: {
                            halign: 'left',
                            fillColor: [255, 255, 224],
                            textColor: '#999999'
                        }
                    },
                    {
                        //yellow box
                        content: bill.hourlyRate.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fillColor: [255, 255, 224],
                            textColor: '#999999'
                        }
                    },
                    {
                        content: ''
                    },
                    {
                        content: 'TVA ' + TVA + '%',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: ((totalData.total / 100) * TVA).toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'MONTANT TOTAL',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            //soft gray box
                            fillColor: [220, 220, 220]
                        }
                    },
                    {
                        content: ((totalData.total + (totalData.total / 100) * TVA)).toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold',
                            //soft gray box
                            fillColor: [220, 220, 220]
                        }
                    }]);

                } if (idTable == 2) {
                    //title+header
                    body = [
                        //title
                        [{
                            content: 'Facture - ' + bill.title,
                            colSpan: 5,
                            styles: {
                                halign: 'center',
                                fontStyle: 'bold',
                                //gray box
                                fillColor: [192, 192, 192]
                            }
                        }],
                        //header
                        [{
                            content: 'Article',
                            colSpan: 4,
                            styles: {
                                textColor: '#999999',
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Montant Totale',
                            styles: {
                                textColor: '#999999',
                                fontStyle: 'bold'
                            }
                        }]
                    ];

                    //content
                    body.push([{
                        content: 'Logiciel',
                        colSpan: 4,
                        styles: {
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.subTotalSoftware.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: 'Service',
                        colSpan: 4,
                        styles: {
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.subTotalService.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 5,
                        styles: {
                            //soft gray box
                            fillColor: [220, 220, 220],
                            drawCell: 1
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 5
                    }]);

                    //hourly rate box
                    body.push([{
                        //yellow box
                        content: 'Tarif horaire hors TVA: ',
                        styles: {
                            halign: 'left',
                            fillColor: [255, 255, 224],
                            textColor: '#999999'
                        }
                    },
                    {
                        //yellow box
                        content: bill.hourlyRate.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fillColor: [255, 255, 224],
                            textColor: '#999999'
                        }
                    },
                    {
                        content: '',
                        colSpan: 3
                    }]);

                    //total box
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'SOUS-TOTAL',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.total.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'TVA ' + TVA + '%',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: ((totalData.total / 100) * TVA).toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'MONTANT TOTAL',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            //soft gray box
                            fillColor: [220, 220, 220]
                        }
                    },
                    {
                        content: ((totalData.total + (totalData.total / 100) * TVA)).toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold',
                            //soft gray box
                            fillColor: [220, 220, 220]
                        }
                    }]);
                }

                //info box
                body.push([{
                    content: '',
                    colSpan: 5
                }]);
                body.push([{
                    content: 'Informations',
                    colSpan: 5,
                    styles: {
                        halign: 'center',
                        fontStyle: 'bold',
                        //gray box
                        fillColor: [192, 192, 192]
                    }
                }]);
                body.push([{
                    content: 'IMPORTANT: Effectuez si possible le paiement au moyen du bulletin de versement annexé.',
                    colSpan: 5,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold',
                        textColor: '#cc0000'
                    }
                }]);
                body.push([{
                    content: 'Paiement par télébanque: Veuillez indiquer le n° de facture. Merci',
                    colSpan: 5,
                    styles: {
                        halign: 'left'
                    }
                }]);
                body.push([{
                    content: 'Payable à 30 jours net',
                    colSpan: 5,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold',
                        textColor: '#cc0000'
                    }
                }]);


                return body
            }

            function getFooter() {
                let footer = [];

                // Footer
                footer = [
                    [{
                        content: 'Page ' + pdf.internal.getNumberOfPages(),
                        styles: {
                            halign: 'right'
                        }
                    }],
                    [{
                        content: cinfo.name,
                        styles: {
                            halign: 'center'
                        }
                    }],
                    [{
                        content: cinfo.street + ', ' + cinfo.city,
                        styles: {
                            halign: 'center'
                        }
                    }],
                    [{
                        content: cinfo.phone + ' - ' + cinfo.mail + ' - ' + cinfo.web,
                        styles: {
                            halign: 'center'
                        }
                    }]
                ];

                return footer
            }

            /* PAGE 1 */
            //set total and subTotal
            calculateTot();

            /*getHeader();

            //tableau principal
            pdf.autoTable({
                startY: 90,
                margin: {
                    bottom: 40
                },
                theme: 'plain',
                styles: {
                    font: 'roboto',
                },
                columnStyles: {
                    2: {
                        halign: 'right',
                        cellWidth: 'wrap'
                    },
                    3: {
                        halign: 'center',
                        cellWidth: 'wrap'
                    },
                    4: {
                        halign: 'right',
                        cellWidth: 'wrap'
                    }
                },
                body: getBody(1),
                didDrawPage: function (data) {

                    // jsPDF 1.4+ uses getWidth, <1.4 uses .width
                    pdf.autoTable({
                        startY: pdf.internal.pageSize.height - 34,
                        margin: data.settings.margin.left,
                        theme: 'plain',
                        styles: {
                            font: 'roboto',
                            fontSize: 6,
                            cellPadding: 0.1,
                        },
                        body: getFooter()
                    });
                }
            });*/

            //pdf.addPage();

            /* LAST PAGE */
            getHeader();

            //Main Data
            pdf.autoTable({
                startY: 90,
                margin: {
                    left: 22,
                },
                theme: 'plain',
                styles: {
                    font: 'roboto',
                    fontSize: 8
                },
                columnStyles: {
                    2: {
                        halign: 'right',
                        cellWidth: 'wrap'
                    },
                    3: {
                        halign: 'center',
                        cellWidth: 'wrap'
                    },
                    4: {
                        halign: 'right',
                        cellWidth: 'wrap'
                    }
                },
                body: getBody(2)
            });

            /* BVR */
            //Bank data
            pdf.autoTable({
                startY: 200,
                theme: env.theme,
                tableWidth: 'wrap',
                margin: {
                    left: 5
                },
                styles: {
                    font: env.font,
                    cellPadding: 0.5,
                },
                body: [
                    [{
                        content: bill.bank.name,
                        styles: {
                            
                        }
                    }],
                    [{
                        content: bill.bank.city,
                        styles: {
                        }
                    }]
                ]
            });

            //CInfo data
            pdf.autoTable({
                startY: 215,
                theme: env.theme,
                tableWidth: 'wrap',
                margin: {
                    left: 5
                },
                styles: {
                    font: env.font,
                    cellPadding: 0.5,
                },
                body: [
                    [{
                        content: cinfo.name,
                        styles: {
                            
                        }
                    }],
                    [{
                        content: cinfo.street,
                        styles: {
                        }
                    }],
                    [{
                        content: cinfo.city,
                        styles: {
                        }
                    }]
                ]
            });

            //Bank acc + price

            //Client data
            pdf.autoTable({
                startY: 240,
                theme: env.theme,
                tableWidth: 'wrap',
                margin: {
                    left: 5
                },
                styles: {
                    font: env.font,
                    cellPadding: 0.5,
                },
                body: [
                    [{
                        content: '10 21390',
                        styles: {
                            
                        }
                    }],
                    [{
                        content: bill.client.name,
                        styles: {
                        }
                    }],
                    [{
                        content: bill.client.street,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.postal,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.city,
                        styles: {
                        }
                    }]
                ]
            });

            var string = pdf.output("datauristring");
            $("iframe").attr("src", string);
        });
    </script>
</body>

</html>