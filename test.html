<!DOCTYPE html>
<html style="height: 100%;">

<head>
    <title>Parcel Sandbox</title>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/jspdf@1.5.3/dist/jspdf.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.3/dist/jspdf.plugin.autotable.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!-- https://rawgit.com/MrRio/jsPDF/master/fontconverter/fontconverter.html -->
    <script type="text/javascript" src="OCR_BB-normal.js"></script>
    <script type="text/javascript" src="roboto-normal.js"></script>
    <script type="text/javascript" src="roboto-italic.js"></script>
    <script type="text/javascript" src="roboto-bold.js"></script>
    <script type="text/javascript" src="roboto-bolditalic.js"></script>
    <!-- Logo en base 64 -->
    <script type="text/javascript" src="logoBase64.js"></script>
</head>

<body style="height: 100%;">
    <iframe frameborder="1" width="100%" height="100%"></iframe>
    <script>
        $(document).ready(function () {
            var pdf = new jsPDF("p", "mm", "a4");

            /******* 
            * DATA *
            ********/
            const TVA = 7.7;

            /* bill data */
            let bill = {
                id: 920030174,
                title: 'Migration messagerie locale vers Microsoft Office 365',
                dateStart: '17.03.2020',
                dateEnd: '16.04.2020',
                infoTVA: 'CHE-631.761 TVA',
                hourlyRate: 150,
                client: {
                    id: 216157,
                    name: 'Etude MCE Avocats',
                    street: 'Grand Chêne 1-3',
                    postal: 'case postale 6868',
                    city: '1002 Lausanne'
                },
                cinfo: {
                    name: 'C Informatique Sàrl',
                    street: 'Route de Larret 19',
                    city: '1870 Monthey',
                    phone: '+41 24 550 56 00',
                    mail: 'informatique@cinformatique.ch',
                    web: 'www.cinformatique.ch'
                },
                bank: {
                    name: 'Banque Contonale du Valais',
                    city: '1951 Sion',
                    account: '01-1502-9',
                    ref: '10 21390 00002 16157 92003 01740'
                },
                lines: [
                    { description: 'Licence BitTitan MigrationWiz', type: 2, price: 20, quantity: 65, total: 1300 },
                    { description: 'Prémigration', type: 3, price: 150, quantity: 28, total: 4200 },
                    { description: '1Migration individuelle des emails', type: 1, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '2Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '3Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '4Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '5Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '6Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '7Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '8Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '9Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '10Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '11Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '12Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '13Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '14Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '15Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '16Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '17Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '18Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '19Migration individuelle des emails', type: 3, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: 'Postmigration', type: 3, price: 150, quantity: 16, total: 2400 },
                    { description: '20Migration individuelle des emails', type: 4, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '21Migration individuelle des emails', type: 5, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '22Migration individuelle des emails', type: 5, price: 112.5, quantity: 65, total: 7312.5 },
                ],
                totalWoTVA: 15212.5,
                totalTVA: 1171.36,
                total: 16383.85,
                serial: '0100016383858>102139000002161579200301740+ 010015029>'
            };

            let splittedLines = {
                hardware: { lines: [], name: 'Matériel', subTotal: 0 },
                software: { lines: [], name: 'Logiciel', subTotal: 0 },
                service: { lines: [], name: 'Service', subTotal: 0 },
                various: { lines: [], name: 'Divers', subTotal: 0 },
                discount: { lines: [], name: 'Rabais', subTotal: 0 },
            };

            //environment data (margin = posX / start = posY)
            let env = {
                font: 'roboto',
                fontBVR: 'OCR_BB',
                fontSize: 10,
                fontSizeTitle: 11,
                fontSizeBVR: 11,
                fontSizeSecondary: 9,
                fontSizeFooter: 7,
                theme: 'plain',
                tableWidth: 'wrap',
                cellPadding: 0.2,
                footerPadding: 0.1,
                marginLeft: 15,
                marginBottom: 30,
                //margin left of elements :
                marginNoBill: 155,
                marginNoClient: 117,
                marginBVR: 5,
                marginBVR2: 65,
                marginBVR3: 130,
                marginSerial: 80,
                marginTot: 54.5,
                marginTot2: 115.5,
                marginAcc: 41,
                marginAcc2: 102,
                //pos Y of elements
                startHeader: 15,
                startFooter: 20, //= page max size - startFooter
                startAdress: 50,
                startMainTable: 85,
                startNoClient: 75,
                startBVR_Bank: 201,
                startBVR_CInfo: 214,
                startBVR_Acc: 238,
                startBVR_Tot: 245.5,
                startBVR_Cli: 254,
                startBVR_Ref: 228.5,
                startBVR_Cli2: 245,
                startBVR_Serial: 281,
                logoHeight: 22,
                logoWidth: 71,
                cellHeight: 6,
                grayText: '#999999',
                blueText: '#1750a0',
                redText: '#ff3b3b',
                yellowBox: '#ffffc4',
                grayBox: '#d2d2d2',
                softGrayBox: '#ececec'
            };

            /************
            * FUNCTIONS *
            *************/
            //format currency
            function formatCurrency(currency) {
                currency = new Intl.NumberFormat("de-CH", { style: 'currency', currency: 'CHF' }).format(currency);

                return currency
            };

            //generate header
            function getHeader() {
                //logo
                pdf.addImage(logoImg, "PNG", env.marginLeft, env.startHeader, env.logoWidth, env.logoHeight);

                //info facture
                pdf.autoTable({
                    startY: env.startHeader,
                    theme: env.theme,
                    tableWidth: env.tableWidth,
                    margin: {
                        left: env.marginNoBill
                    },
                    styles: {
                        font: env.font,
                        fontSize: env.fontSizeSecondary,
                        cellPadding: env.cellPadding,
                        halign: 'right',
                    },
                    body: [
                        [{
                            content: "N° de facture",
                            colSpan: 2,
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold',
                                fontSize: env.fontSizeTitle,
                            }
                        }],
                        [{
                            content: bill.id,
                            colSpan: 2,
                            styles: {
                                fontStyle: 'bold',
                                textColor: env.blueText,
                                fontSize: env.fontSizeTitle,
                                minCellHeight: env.cellHeight,
                            }
                        }],
                        [{
                            content: "Date d'émission:",
                            styles: {
                                halign: 'right',
                            }
                        }, {
                            content: bill.dateStart,
                            styles: {
                                fontStyle: 'bold',
                            }
                        }],
                        [{
                            content: "Échéance:",
                            styles: {
                                halign: 'right',
                            }
                        }, {
                            content: bill.dateEnd,
                            styles: {
                                fontStyle: 'bold',
                            }
                        }],
                        [{
                            content: bill.infoTVA,
                            colSpan: 2
                        }]
                    ]
                });

                // Addresse client
                pdf.autoTable({
                    startY: env.startAdress,
                    theme: env.theme,
                    tableWidth: env.tableWidth,
                    margin: {
                        left: env.marginLeft
                    },
                    styles: {
                        font: env.font,
                        fontSize: env.fontSize,
                        cellPadding: env.cellPadding,
                    },
                    body: [
                        [{
                            content: 'Adresse du client',
                            styles: {
                                fontStyle: 'bold',
                                minCellHeight: env.cellHeight
                            }
                        }],
                        [{ content: bill.client.name }],
                        [{ content: bill.client.street }],
                        [{ content: bill.client.postal }],
                        [{ content: bill.client.city }]

                    ]
                });

                //numero client
                pdf.autoTable({
                    startY: env.startNoClient,
                    theme: env.theme,
                    margin: {
                        left: env.marginNoClient,
                    },
                    styles: {
                        font: env.font,
                        fontSize: env.fontSizeSecondary,
                        textColor: env.grayText,
                        fillColor: env.yellowBox,
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        1: {
                            halign: 'right'
                        }
                    },
                    body: [
                        ['Numéro de client', bill.client.id]
                    ]
                });

            }

            //split raw data and calculate sub total
            function setData() {
                bill.lines.forEach(i => {
                    switch (i.type) {
                        case 1:
                            splittedLines.hardware.lines.push(i);
                            splittedLines.hardware.subTotal += i.total;
                            break;
                        case 2:
                            splittedLines.software.lines.push(i);
                            splittedLines.software.subTotal += i.total;
                            break;
                        case 3:
                            splittedLines.service.lines.push(i);
                            splittedLines.service.subTotal += i.total;
                            break;
                        case 4:
                            splittedLines.various.lines.push(i);
                            splittedLines.various.subTotal += i.total;
                            break;
                        case 5:
                            splittedLines.discount.lines.push(i);
                            splittedLines.discount.subTotal += i.total;
                            break;
                    }
                })
            };

            //generate body data
            function getData(idTable) {
                let body = [];
                //title
                body = [[{
                    content: 'Facture - ' + bill.title,
                    colSpan: 5,
                    styles: {
                        halign: 'center',
                        fontSize: env.fontSizeTitle,
                        fontStyle: 'bold',
                        fillColor: env.grayBox
                    }
                }]];

                //first page table or last page table
                switch (idTable) {
                    case 1: {
                        //header table 1
                        body.push([{
                            content: 'Article',
                            colSpan: 2,
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Prix unitaire',
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Quantité',
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Montant Total',
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        }]);

                        for (const key in splittedLines) {
                            if (splittedLines[key].lines.length > 0) {
                                //header
                                body.push([{
                                    content: splittedLines[key].name,
                                    colSpan: 5,
                                    styles: {
                                        halign: 'left',
                                        fontStyle: 'bold',
                                        fillColor: env.softGrayBox
                                    }
                                }]);
                                //lines data
                                splittedLines[key].lines.forEach(i => {
                                    body.push([
                                        {
                                            content: i.description,
                                            colSpan: 2
                                        },
                                        {
                                            content: formatCurrency(i.price)
                                        },
                                        {
                                            content: i.quantity.toFixed(2)
                                        },
                                        {
                                            content: formatCurrency(i.total)
                                        }
                                    ]);

                                })

                                //subtotal
                                body.push([{
                                    content: '',
                                    colSpan: 3
                                },
                                {
                                    content: 'Sous total',
                                    styles: {
                                        fontStyle: 'bold'
                                    }
                                },
                                {
                                    content: formatCurrency(splittedLines[key].subTotal),
                                    styles: {
                                        fontStyle: 'bold'
                                    }
                                }]);
                            }
                        }
                        break;
                    }
                    case 2: {
                        //header table 2
                        body.push([{
                            content: 'Article',
                            colSpan: 4,
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Montant Total',
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        }]);

                        for (const key in splittedLines) {
                            //data
                            if (splittedLines[key].lines.length > 0) {
                                body.push([{
                                    content: splittedLines[key].name,
                                    colSpan: 4,
                                    styles: {
                                        fontStyle: 'bold'
                                    }
                                },
                                {
                                    content: formatCurrency(splittedLines[key].subTotal),
                                    styles: {
                                        halign: 'right',
                                        fontStyle: 'bold'
                                    }
                                }]);
                            }
                        }

                        //soft gray line
                        body.push([{
                            content: '',
                            colSpan: 5,
                            styles: {
                                fillColor: env.softGrayBox,
                                cellPadding: 0,
                            }
                        }]);

                        break;
                    }
                }

                //total box
                body.push([{
                    content: '',
                    colSpan: 5,
                    styles: {
                        cellPadding: 0,
                    }
                }]);
                body.push([{
                    //yellow box
                    content: 'Tarif horaire hors TVA: ',
                    styles: {
                        halign: 'left',
                        fillColor: env.yellowBox,
                        textColor: env.grayText,
                        fontStyle: 'bold'
                    }
                },
                {
                    //yellow box
                    content: formatCurrency(bill.hourlyRate),
                    styles: {
                        halign: 'right',
                        fillColor: env.yellowBox,
                        textColor: env.grayText,
                        fontStyle: 'bold'
                    }
                },
                {
                    content: ''
                },
                {
                    content: 'SOUS-TOTAL',
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: formatCurrency(bill.totalWoTVA),
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: '',
                    colSpan: 3
                },
                {
                    content: 'TVA ' + TVA + '%',
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: formatCurrency(bill.totalTVA),
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: '',
                    colSpan: 3
                },
                {
                    content: 'MONTANT TOTAL',
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold',
                        fillColor: env.softGrayBox
                    }
                },
                {
                    content: formatCurrency(bill.total),
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold',
                        fillColor: env.softGrayBox
                    }
                }]);


                //info box
                body.push([{
                    content: '',
                    colSpan: 5,
                    styles: {
                        cellPadding: 0,
                    }
                }]);
                body.push([{
                    content: 'Informations',
                    colSpan: 5,
                    styles: {
                        halign: 'center',
                        fontStyle: 'bold',
                        fillColor: env.grayBox,
                        fontSize: env.fontSizeTitle,
                        cellPadding: 1
                    }
                }]);
                body.push([{
                    content: 'IMPORTANT: Effectuez si possible le paiement au moyen du bulletin de versement annexé.',
                    colSpan: 5,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold',
                        textColor: env.redText,
                        cellPadding: 0.1
                    }
                }]);
                body.push([{
                    content: 'Paiement par télébanque: Veuillez indiquer le n° de facture. Merci',
                    colSpan: 5,
                    styles: {
                        halign: 'left',
                        cellPadding: 0.1
                    }
                }]);
                body.push([{
                    content: 'Payable à 30 jours net',
                    colSpan: 5,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold',
                        textColor: env.redText,
                        cellPadding: 0.1
                    }
                }]);

                return body;
            }

            //generate footer
            function getFooter() {
                let footer = [];

                // Footer
                footer = [
                    [{
                        content: 'Page ' + pdf.internal.getNumberOfPages(),
                        styles: {
                            halign: 'right'
                        }
                    }],
                    [{
                        content: bill.cinfo.name,
                        styles: {
                            halign: 'center'
                        }
                    }],
                    [{
                        content: bill.cinfo.street + ', ' + bill.cinfo.city,
                        styles: {
                            halign: 'center'
                        }
                    }],
                    [{
                        content: bill.cinfo.phone + ' - ' + bill.cinfo.mail + ' - ' + bill.cinfo.web,
                        styles: {
                            halign: 'center'
                        }
                    }]
                ];

                return footer
            }

            //print total for BVR
            function makeBVRTot(posX, posY, tot) {
                let arrayTot = [];
                tot = '' + tot;
                arrayTot = tot.match(/.{1}/g);
                arrayTot.reverse();
                if (!arrayTot.includes('.')) {
                    posX -= 15;
                }
                arrayTot.forEach(i => {
                    if (i != ".") {
                        pdf.text(i, posX, posY);
                    }
                    posX -= 5;
                });
            }

            /*************
            * First Page *
            **************/
            setData();

            getHeader();

            //Main Data
            pdf.autoTable({
                startY: env.startMainTable,
                margin: {
                    left: env.marginLeft,
                    bottom: env.marginBottom,
                },
                theme: env.theme,
                styles: {
                    font: env.font,
                    fontSize: env.fontSizeSecondary,
                },
                columnStyles: {
                    2: {
                        halign: 'right'
                    },
                    3: {
                        halign: 'center'
                    },
                    4: {
                        halign: 'right'
                    }
                },
                body: getData(1),
                didDrawPage: function (data) {
                    // jsPDF 1.4+ uses getWidth, <1.4 uses .width
                    pdf.autoTable({
                        startY: pdf.internal.pageSize.height - env.startFooter,
                        margin: {
                            bottom: 0,
                        },
                        theme: env.theme,
                        pageBreak: 'avoid',
                        styles: {
                            font: env.font,
                            fontSize: env.fontSizeFooter,
                            cellPadding: env.footerPadding,
                        },
                        body: getFooter()
                    });
                }
            });

            pdf.addPage();

            /************
            * Last Page * 
            *************/

            getHeader();

            //Main Data
            pdf.autoTable({
                startY: env.startMainTable,
                margin: {
                    left: env.marginLeft,
                },
                theme: env.theme,
                styles: {
                    font: env.font,
                    fontSize: env.fontSizeSecondary
                },
                columnStyles: {
                    2: {
                        halign: 'right'
                    },
                    3: {
                        halign: 'center'
                    },
                    4: {
                        halign: 'right'
                    }
                },
                body: getData(2)
            });

            /******
            * BVR * 
            *******/

            //Bank data
            pdf.autoTable({
                startY: env.startBVR_Bank,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR
                },
                styles: {
                    font: env.font,
                    fontSize: env.fontSizeSecondary,
                    cellPadding: 0
                },
                body: [
                    [{
                        content: bill.bank.name,
                        styles: {

                        }
                    }],
                    [{
                        content: bill.bank.city,
                        styles: {
                        }
                    }]
                ]
            });
            pdf.autoTable({
                startY: env.startBVR_Bank,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR2
                },
                styles: {
                    font: env.font,
                    fontSize: env.fontSizeSecondary,
                    cellPadding: 0,
                },
                body: [
                    [{
                        content: bill.bank.name,
                        styles: {

                        }
                    }],
                    [{
                        content: bill.bank.city,
                        styles: {
                        }
                    }]
                ]
            });

            //CInfo data
            pdf.autoTable({
                startY: env.startBVR_CInfo,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR
                },
                styles: {
                    font: env.font,
                    fontSize: env.fontSizeSecondary,
                    cellPadding: 0,
                },
                body: [
                    [{
                        content: bill.cinfo.name,
                        styles: {

                        }
                    }],
                    [{
                        content: bill.cinfo.street,
                        styles: {
                        }
                    }],
                    [{
                        content: bill.cinfo.city,
                        styles: {
                        }
                    }]
                ]
            });
            pdf.autoTable({
                startY: env.startBVR_CInfo,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR2
                },
                styles: {
                    font: env.font,
                    fontSize: env.fontSizeSecondary,
                    cellPadding: 0,
                },
                body: [
                    [{
                        content: bill.cinfo.name,
                        styles: {

                        }
                    }],
                    [{
                        content: bill.cinfo.street,
                        styles: {
                        }
                    }],
                    [{
                        content: bill.cinfo.city,
                        styles: {
                        }
                    }]
                ]
            });



            //Client data
            pdf.autoTable({
                startY: env.startBVR_Cli,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR
                },
                styles: {
                    font: env.font,
                    fontSize: env.fontSizeSecondary-1,
                    cellPadding: 0,
                },
                body: [
                    [{
                        content: bill.bank.ref,
                        styles: {

                        }
                    }],
                    [{
                        content: bill.client.name,
                        styles: {
                        }
                    }],
                    [{
                        content: bill.client.street,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.postal,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.city,
                        styles: {
                        }
                    }]
                ]
            });
            pdf.autoTable({
                startY: env.startBVR_Cli2,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR3
                },
                styles: {
                    font: env.font,
                    fontSize: env.fontSize,
                    cellPadding: 0,
                },
                body: [
                    [{
                        content: bill.client.name,
                        styles: {
                        }
                    }],
                    [{
                        content: bill.client.street,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.postal,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.city,
                        styles: {
                        }
                    }]
                ]
            });

            //BVR Data with OCR Font
            pdf.setFont(env.fontBVR);
            //Bank acc
            pdf.setFontSize(env.fontSizeSecondary);
            pdf.text(bill.bank.account, env.marginAcc, env.startBVR_Acc);
            pdf.text(bill.bank.account, env.marginAcc2, env.startBVR_Acc);
            //ref + serial
            pdf.text(env.marginBVR3, env.startBVR_Ref, '' + bill.bank.ref);
            pdf.setFontSize(env.fontSizeBVR);
            pdf.text(env.marginSerial, env.startBVR_Serial, '' + bill.serial);
            //Total
            pdf.setFontSize(env.fontSize);
            makeBVRTot(env.marginTot, env.startBVR_Tot, bill.total);
            makeBVRTot(env.marginTot2, env.startBVR_Tot, bill.total);

            //generate page
            var string = pdf.output("datauristring");
            $("iframe").attr("src", string);
        });
    </script>
</body>

</html>