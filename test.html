<!DOCTYPE html>
<html style="height: 100%;">

<head>
    <title>Parcel Sandbox</title>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/jspdf@1.5.3/dist/jspdf.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.3/dist/jspdf.plugin.autotable.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!-- https://rawgit.com/MrRio/jsPDF/master/fontconverter/fontconverter.html -->
    <script type="text/javascript" src="roboto-normal.js"></script>
    <script type="text/javascript" src="roboto-italic.js"></script>
    <script type="text/javascript" src="roboto-bold.js"></script>
    <script type="text/javascript" src="roboto-bolditalic.js"></script>
    <!-- Logo en base 64 -->
    <script type="text/javascript" src="logoBase64.js"></script>
</head>

<body style="height: 100%;">
    <iframe frameborder="1" width="100%" height="100%"></iframe>
    <script>

        $(document).ready(function () {
            var pdf = new jsPDF("p", "mm", "a4");

            /* DATA */
            const TVA = 7.7;
            let totalData = {
                total: 0,
                subTotalSoftware: 0,
                subTotalService: 0
            };

            /* bill data */
            let bill = {
                id: 920030174,
                title: 'Migration messagerie locale vers Microsoft Office 365',
                dateStart: '17.03.2020',
                dateEnd: '16.04.2020',
                infoTVA: 'CHE-631.761 TVA',
                hourlyRate: 150,
                client: {
                    id: 216157,
                    name: 'Etude MCE Avocats',
                    street: 'Grand Chêne 1-3',
                    postal: 'case postale 6868',
                    city: '1002 Lausanne'
                },
                bank: {
                    name: 'Banque Contonale du Valais',
                    city: '1951 Sion',
                    account: '01-1502-9',
                    ref: '10 21390 00002 16157 92003 01740'
                },
                lines: [
                    { description: 'Licence BitTitan MigrationWiz', type: 1, price: 20, quantity: 65, total: 1300 },
                    { description: 'Prémigration', type: 2, price: 150, quantity: 28, total: 4200 },
                    { description: '1Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '2Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '3Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '4Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '5Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '6Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '7Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '8Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '9Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '10Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '11Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '12Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '13Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '14Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '15Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '16Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '17Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '18Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: '19Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: 'Postmigration', type: 2, price: 150, quantity: 16, total: 2400 }
                ],
                total: 16383.85,
                serial: '0100016383858>102139000002161579200301740+ 010015029'
            };

            let cinfo = {
                name: 'C Informatique Sàrl',
                street: 'Route de Larret 19',
                city: '1870 Monthey',
                phone: '+41 24 550 56 00',
                mail: 'informatique@cinformatique.ch',
                web: 'www.cinformatique.ch'
            };

            let env = {
                font: 'roboto',
                fontSize: 8,
                theme: 'plain',
                tableWidth: 'wrap',
                cellPadding: 0.5,
                footerPadding: 0.1,
                footerFontSize: 6,
                marginLeft: 15,
                marginBottom: 40,
                marginBVR: 5,
                marginBVR2: 65,
                marginBVR3: 130,
                marginSerial: 90,
                startHeader: 15,
                startAdress: 50,
                startMainTable: 90,
                startNoClient: 70,
                startBVR_Bank: 200,
                startBVR_CInfo: 215,
                startBVR_Acc: 240,
                startBVR_Tot: 245,
                startBVR_Cli: 255,
                startBVR_Ref: 230,
                startBVR_Cli2: 240,
                startBVR_Serial: 280,
                logoHeight: 22,
                logoWidth: 71,
                grayText: '#999999',
                blueText: '#1750a0',
                redText: '#cc0000',
                yellowBox: [255, 255, 224],
                grayBox: [192, 192, 192],
                softGrayBox: [220, 220, 220]
            };

            /* FUNCTIONS */
            //calculate total and subTotal
            function calculateTot() {
                for (let i = 0; i < bill.lines.length; i++) {
                    //total
                    totalData.total += bill.lines[i].price * bill.lines[i].quantity;

                    //subtotal
                    if (bill.lines[i].type == 1) {
                        totalData.subTotalSoftware += bill.lines[i].price * bill.lines[i].quantity;
                    }
                    if (bill.lines[i].type == 2) {
                        totalData.subTotalService += bill.lines[i].price * bill.lines[i].quantity;
                    }

                }
            };

            //currency format A FAIRE

            //generate header
            function getHeader() {
                //logo
                pdf.addImage(logoImg, "PNG", env.marginLeft, env.startHeader, env.logoWidth, env.logoHeight);

                //info facture
                pdf.autoTable({
                    startY: env.startHeader,
                    theme: env.theme,
                    tableWidth: env.tableWidth,
                    margin: {
                        left: 150,
                    },
                    styles: {
                        font: env.font,
                        cellPadding: env.cellPadding,
                        halign: 'right',
                    },
                    body: [
                        [{
                            content: "N° de facture",
                            colSpan: 2,
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        }],
                        [{
                            content: bill.id,
                            colSpan: 2,
                            styles: {
                                fontStyle: 'bold',
                                textColor: env.blueText
                            }
                        }],
                        [{
                            content: "Date d'émission:"
                        }, {
                            content: bill.dateStart,
                            styles: {
                                fontStyle: 'bold',
                            }
                        }],
                        [{
                            content: "Échéance:"
                        }, {
                            content: bill.dateEnd,
                            styles: {
                                fontStyle: 'bold',
                            }
                        }],
                        [{
                            content: bill.infoTVA,
                            colSpan: 2
                        }]
                    ]
                });

                // Addresse client
                pdf.autoTable({
                    startY: env.startAdress,
                    theme: env.theme,
                    tableWidth: env.tableWidth,
                    margin: {
                        left: env.marginLeft
                    },
                    styles: {
                        font: env.font,
                        cellPadding: env.cellPadding,
                    },
                    body: [
                        [{
                            content: 'Adresse du client',
                            styles: {
                                fontStyle: 'bold'
                            }
                        }],
                        [{ content: bill.client.name }],
                        [{ content: bill.client.street }],
                        [{ content: bill.client.postal }],
                        [{ content: bill.client.city }]

                    ]
                });

                //numero client
                pdf.autoTable({
                    startY: env.startNoClient,
                    theme: env.theme,
                    margin: {
                        left: 130,
                    },

                    styles: {
                        font: env.font,
                        textColor: env.grayText,
                        //yellow box
                        fillColor: env.yellowBox
                    },
                    columnStyles: {
                        0: {
                            fontStyle: 'bold',
                        },
                        1: {
                            halign: 'right',
                        },
                    },
                    body: [
                        ['Numéro de client', bill.client.id]
                    ]
                });

            }

            //generate main data for body
            function generateData(billLineType, data) {
                bill.lines.forEach(i => {
                    if (i.type == billLineType) {
                        data.push([
                            {
                                content: i.description,
                                colSpan: 2,
                                styles: {
                                }
                            },
                            {
                                content: i.price.toFixed(2) + ' CHF',
                                styles: {
                                }
                            },
                            {
                                content: i.quantity.toFixed(2),
                                styles: {
                                }
                            },
                            {
                                content: i.total.toFixed(2) + ' CHF',
                                styles: {
                                }
                            }
                        ]);
                    }
                })
            }

            //generate body
            function getBody(idTable) {
                let body = [];

                if (idTable == 1) {
                    //title+header
                    body = [
                        //title
                        [{
                            content: 'Facture - ' + bill.title,
                            colSpan: 5,
                            styles: {
                                halign: 'center',
                                fontStyle: 'bold',
                                fillColor: env.grayBox
                            }
                        }],
                        //header
                        [{
                            content: 'Article',
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        }, {
                            content: '',
                        },
                        {
                            content: 'Prix unitaire',
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Quantité',
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Montant Totale',
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        }]
                    ];

                    //header 1st content
                    body.push([{
                        content: 'Logiciel',
                        colSpan: 5,
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            fillColor: env.softGrayBox
                        }
                    }]);
                    //1st content
                    generateData(1, body);
                    //1st subtotal
                    body.push([{
                        content: 'Sous total',
                        colSpan: 4,
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.subTotalSoftware.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);

                    //header 2nd content
                    body.push([{
                        content: 'Service',
                        colSpan: 5,
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            fillColor: env.softGrayBox
                        }
                    }]);
                    //2nd content
                    generateData(2, body);
                    //2nd subtotal
                    body.push([{
                        content: 'Sous total',
                        colSpan: 4,
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.subTotalService.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: 'Facture ' + bill.id + ': ' + bill.title,
                        colSpan: 5,
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            fillColor: env.softGrayBox
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 5
                    }]);

                    //total box
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'SOUS-TOTAL',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.total.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        //yellow box
                        content: 'Tarif horaire hors TVA: ',
                        styles: {
                            halign: 'left',
                            fillColor: env.yellowBox,
                            textColor: env.grayText
                        }
                    },
                    {
                        //yellow box
                        content: bill.hourlyRate.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fillColor: env.yellowBox,
                            textColor: env.grayText
                        }
                    },
                    {
                        content: ''
                    },
                    {
                        content: 'TVA ' + TVA + '%',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: ((totalData.total / 100) * TVA).toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'MONTANT TOTAL',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            fillColor: env.softGrayBox
                        }
                    },
                    {
                        content: ((totalData.total + (totalData.total / 100) * TVA)).toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold',
                            fillColor: env.softGrayBox
                        }
                    }]);

                } if (idTable == 2) {
                    //title+header
                    body = [
                        //title
                        [{
                            content: 'Facture - ' + bill.title,
                            colSpan: 5,
                            styles: {
                                halign: 'center',
                                fontStyle: 'bold',
                                fillColor: env.grayBox
                            }
                        }],
                        //header
                        [{
                            content: 'Article',
                            colSpan: 4,
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        },
                        {
                            content: 'Montant Totale',
                            styles: {
                                textColor: env.grayText,
                                fontStyle: 'bold'
                            }
                        }]
                    ];

                    //content
                    body.push([{
                        content: 'Logiciel',
                        colSpan: 4,
                        styles: {
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.subTotalSoftware.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: 'Service',
                        colSpan: 4,
                        styles: {
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.subTotalService.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 5,
                        styles: {
                            fillColor: env.softGrayBox,
                            drawCell: 1
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 5
                    }]);

                    //hourly rate box
                    body.push([{
                        //yellow box
                        content: 'Tarif horaire hors TVA: ',
                        styles: {
                            halign: 'left',
                            fillColor: env.yellowBox,
                            textColor: env.grayText
                        }
                    },
                    {
                        //yellow box
                        content: bill.hourlyRate.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fillColor: env.yellowBox,
                            textColor: env.grayText
                        }
                    },
                    {
                        content: '',
                        colSpan: 3
                    }]);

                    //total box
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'SOUS-TOTAL',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: totalData.total.toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'TVA ' + TVA + '%',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold'
                        }
                    },
                    {
                        content: ((totalData.total / 100) * TVA).toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);
                    body.push([{
                        content: '',
                        colSpan: 3
                    },
                    {
                        content: 'MONTANT TOTAL',
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold',
                            fillColor: env.softGrayBox
                        }
                    },
                    {
                        content: ((totalData.total + (totalData.total / 100) * TVA)).toFixed(2) + ' CHF',
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold',
                            fillColor: env.softGrayBox
                        }
                    }]);
                }

                //info box
                body.push([{
                    content: '',
                    colSpan: 5
                }]);
                body.push([{
                    content: 'Informations',
                    colSpan: 5,
                    styles: {
                        halign: 'center',
                        fontStyle: 'bold',
                        fillColor: env.grayBox
                    }
                }]);
                body.push([{
                    content: 'IMPORTANT: Effectuez si possible le paiement au moyen du bulletin de versement annexé.',
                    colSpan: 5,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold',
                        textColor: env.redText
                    }
                }]);
                body.push([{
                    content: 'Paiement par télébanque: Veuillez indiquer le n° de facture. Merci',
                    colSpan: 5,
                    styles: {
                        halign: 'left'
                    }
                }]);
                body.push([{
                    content: 'Payable à 30 jours net',
                    colSpan: 5,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold',
                        textColor: env.redText
                    }
                }]);


                return body
            }

            //generate footer
            function getFooter() {
                let footer = [];

                // Footer
                footer = [
                    [{
                        content: 'Page ' + pdf.internal.getNumberOfPages(),
                        styles: {
                            halign: 'right'
                        }
                    }],
                    [{
                        content: cinfo.name,
                        styles: {
                            halign: 'center'
                        }
                    }],
                    [{
                        content: cinfo.street + ', ' + cinfo.city,
                        styles: {
                            halign: 'center'
                        }
                    }],
                    [{
                        content: cinfo.phone + ' - ' + cinfo.mail + ' - ' + cinfo.web,
                        styles: {
                            halign: 'center'
                        }
                    }]
                ];

                return footer
            }

            //set total and subTotal
            calculateTot();

            /*************
            * First Page *
            **************/

            getHeader();

            //Main Data
            pdf.autoTable({
                startY: env.startMainTable,
                margin: {
                    left: env.marginLeft,
                    bottom: env.marginBottom
                },
                theme: env.theme,
                styles: {
                    font: env.font,
                },
                columnStyles: {
                    2: {
                        halign: 'right'
                    },
                    3: {
                        halign: 'center'
                    },
                    4: {
                        halign: 'right'
                    }
                },
                body: getBody(1),
                didDrawPage: function (data) {
                    // jsPDF 1.4+ uses getWidth, <1.4 uses .width
                    pdf.autoTable({
                        startY: pdf.internal.pageSize.height - env.marginBottom+10,
                        margin: data.settings.margin.left,
                        theme: env.theme,
                        styles: {
                            font: env.font,
                            fontSize: env.footerFontSize,
                            cellPadding: env.footerPadding,
                        },
                        body: getFooter()
                    });
                }
            });

            pdf.addPage();

            /************
            * Last Page * 
            *************/

            getHeader();

            //Main Data
            pdf.autoTable({
                startY: env.startMainTable,
                margin: {
                    left: env.marginLeft,
                },
                theme: env.theme,
                styles: {
                    font: env.font,
                    fontSize: env.fontSize
                },
                columnStyles: {
                    2: {
                        halign: 'right'
                    },
                    3: {
                        halign: 'center'
                    },
                    4: {
                        halign: 'right'
                    }
                },
                body: getBody(2)
            });

            /******
            * BVR * 
            *******/
            
            //Bank data
            pdf.autoTable({
                startY: env.startBVR_Bank,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR
                },
                styles: {
                    font: env.font,
                    cellPadding: env.cellPadding,
                },
                body: [
                    [{
                        content: bill.bank.name,
                        styles: {
                            
                        }
                    }],
                    [{
                        content: bill.bank.city,
                        styles: {
                        }
                    }]
                ]
            });

            pdf.autoTable({
                startY: env.startBVR_Bank,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR2
                },
                styles: {
                    font: env.font,
                    cellPadding: env.cellPadding,
                },
                body: [
                    [{
                        content: bill.bank.name,
                        styles: {
                            
                        }
                    }],
                    [{
                        content: bill.bank.city,
                        styles: {
                        }
                    }]
                ]
            });

            //CInfo data
            pdf.autoTable({
                startY: env.startBVR_CInfo,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR
                },
                styles: {
                    font: env.font,
                    cellPadding: env.cellPadding,
                },
                body: [
                    [{
                        content: cinfo.name,
                        styles: {
                            
                        }
                    }],
                    [{
                        content: cinfo.street,
                        styles: {
                        }
                    }],
                    [{
                        content: cinfo.city,
                        styles: {
                        }
                    }]
                ]
            });

            pdf.autoTable({
                startY: env.startBVR_CInfo,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR2
                },
                styles: {
                    font: env.font,
                    cellPadding: env.cellPadding,
                },
                body: [
                    [{
                        content: cinfo.name,
                        styles: {
                            
                        }
                    }],
                    [{
                        content: cinfo.street,
                        styles: {
                        }
                    }],
                    [{
                        content: cinfo.city,
                        styles: {
                        }
                    }]
                ]
            });

            //Bank acc + price
            pdf.setFontSize(10);
            pdf.text(env.marginBVR+15, env.startBVR_Acc, '' + bill.bank.account);
            pdf.text(env.marginBVR+15, env.startBVR_Tot, '' + bill.total);

            pdf.text(env.marginBVR2+20, env.startBVR_Acc, '' + bill.bank.account);
            pdf.text(env.marginBVR2+20, env.startBVR_Tot, '' + bill.total);

            //Client data
            pdf.autoTable({
                startY: env.startBVR_Cli,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR
                },
                styles: {
                    font: env.font,
                    cellPadding: env.cellPadding,
                },
                body: [
                    [{
                        content: bill.bank.ref,
                        styles: {
                            
                        }
                    }],
                    [{
                        content: bill.client.name,
                        styles: {
                        }
                    }],
                    [{
                        content: bill.client.street,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.postal,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.city,
                        styles: {
                        }
                    }]
                ]
            });

            pdf.text(env.marginBVR3, env.startBVR_Ref, '' + bill.bank.ref);

            pdf.autoTable({
                startY: env.startBVR_Cli2,
                theme: env.theme,
                tableWidth: env.tableWidth,
                margin: {
                    left: env.marginBVR3
                },
                styles: {
                    font: env.font,
                    cellPadding: env.cellPadding,
                },
                body: [
                    [{
                        content: bill.client.name,
                        styles: {
                        }
                    }],
                    [{
                        content: bill.client.street,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.postal,
                        styles: {
                        }
                    }]
                    ,
                    [{
                        content: bill.client.city,
                        styles: {
                        }
                    }]
                ]
            });

            //BVR Serial
            pdf.text(env.marginSerial, env.startBVR_Serial, '' + bill.serial);
            
            var string = pdf.output("datauristring");
            $("iframe").attr("src", string);
        });
    </script>
</body>

</html>