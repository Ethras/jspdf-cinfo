<!DOCTYPE html>
<html style="height: 100%;">

<head>
    <title>Parcel Sandbox</title>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/jspdf@1.5.3/dist/jspdf.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.3/dist/jspdf.plugin.autotable.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
</head>

<body style="height: 100%;">
    <iframe frameborder="1" width="100%" height="100%"></iframe>
    <script>
        $(document).ready(function () {
            var pdf = new jsPDF("p", "mm", "a4");

            /* DATA */
            const TVA = 7.7;
            let totalData = {
                total: 0,
                subTotalSoftware: 0,
                subTotalService: 0
            };

            /* bill data */
            let bill = {
                id: 920030174,
                title: 'Migration messagerie locale vers Microsoft Office 365',
                dateStart: '17.03.2020',
                dateEnd: '16.04.2020',
                hourlyRate: 150.0,
                client: {
                    id: 216157,
                    name: 'Etude MCE Avocats',
                    street: 'Grand Chêne 1-3',
                    postal: 'case postale 6868',
                    city: '1002 Lausanne'
                },
                lines: [
                    { description: 'Licence BitTitan MigrationWiz', type: 1, price: 20, quantity: 65, total: 1300 },
                    { description: 'Prémigration', type: 2, price: 150, quantity: 28, total: 4200 },
                    { description: 'Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: 'Postmigration', type: 2, price: 150, quantity: 16, total: 2400 }
                ],
                total: 432432
            };

            /* FUNCTIONS */
            //calculate total and subTotal
            function calculateTot() {
                for (let i = 0; i < bill.lines.length; i++) {
                    //total
                    totalData.total += bill.lines[i].price * bill.lines[i].quantity;

                    //subtotal
                    if (bill.lines[i].type == 1) {
                        totalData.subTotalSoftware += bill.lines[i].price * bill.lines[i].quantity;
                    }
                    if (bill.lines[i].type == 2) {
                        totalData.subTotalService += bill.lines[i].price * bill.lines[i].quantity;
                    }

                }
            };

            //generate main data for body
            function generateData(billLineType, data) {
                bill.lines.forEach(i => {
                    if (i.type == billLineType) {
                        data.push([
                            {
                                content: i.description,
                                styles: {
                                }
                            },
                            {
                                content: i.price,
                                styles: {
                                }
                            },
                            {
                                content: i.quantity,
                                styles: {
                                }
                            },
                            {
                                content: i.total,
                                styles: {
                                }
                            }
                        ]);
                    }
                })
            };

            function getBody() {
                let body = [];

                //header
                body = [
                    //Title: gray box
                    [{
                        content: 'Facture - ' + bill.title,
                        colSpan: 4,
                        styles: {
                            halign: 'center',
                            fontStyle: 'bold'
                        }
                    }],
                    //header: gray font
                    ['Article', 'Prix unitaire', 'Quantité', 'Montant Total'],
                ]

                //header 1st content: soft gray box
                body.push([{
                    content: 'Logiciel',
                    colSpan: 4,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold'
                    }
                }]);
                //1st content
                generateData(1, body);
                //1st subtotal
                body.push([{
                    content: 'Sous total',
                    colSpan: 3,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: totalData.subTotalSoftware + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);

                //header 2nd content: soft gray box
                body.push([{
                    content: 'Service',
                    colSpan: 4,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold'
                    }
                }]);
                //2nd content
                generateData(2, body);
                //2nd subtotal
                body.push([{
                    content: 'Sous total',
                    colSpan: 3,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: totalData.subTotalService + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: 'Facture ' + bill.id + ': ' + bill.title,
                    colSpan: 4,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: '',
                    colSpan: 4
                }]);

                //total box
                body.push([{
                    content: 'SOUS-TOTAL',
                    colSpan: 3,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: totalData.total + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    //add yellow box
                    content: 'Tarif horaire hors TVA: ' + bill.hourlyRate + ' CHF',
                    colSpan: 2,
                    styles: {
                        halign: 'left'
                    }
                },
                {
                    content: 'TVA ' + TVA + '%',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: ((totalData.total / 100) * TVA) + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: 'MONTANT TOTAL',
                    colSpan: 3,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: (totalData.total + (totalData.total / 100) * TVA) + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: '',
                    colSpan: 4
                }]);
                
                //info box
                body.push([{
                        content: 'Informations',
                        colSpan: 4,
                        styles: {
                            halign: 'center',
                            fontStyle: 'bold'
                        }
                    }]);
                body.push([{
                        content: 'Lorem ipsum',
                        colSpan: 4,
                        styles: {
                            halign: 'left',
                            fontStyle: 'bold'
                        }
                    }]);
                body.push([{
                        content: 'Lorem ipsum2',
                        colSpan: 4,
                        styles: {
                            halign: 'left'
                        }
                    }]);
                body.push([{
                        content: 'Payable à 30 jours net',
                        colSpan: 4,
                        styles: {
                            halign: 'right',
                            fontStyle: 'bold'
                        }
                    }]);

                return body
            };

            /* PAGE */
            //set total and subTotal
            calculateTot();

            // Test text - logo?
            pdf.setFontSize(40);
            pdf.text(20, 20, "Hello world");

            // Addresse client
            pdf.autoTable({
                startY: 53,
                tableWidth: 'wrap',
                margin: {
                    left: 22
                },
                styles: {
                    fillColor: [255, 255, 255],
                    cellPadding: 0.5,
                },
                alternateRowStyles: {
                    fillColor: [255, 255, 255],
                },
                body: [
                    [{
                        content: 'Adresse du client',
                        styles: {
                            fontStyle: 'bold'
                        }
                    }],
                    [{ content: bill.client.name }],
                    [{ content: bill.client.street }],
                    [{ content: bill.client.postal }],
                    [{ content: bill.client.city }]

                ]
            });

            //info facture
            pdf.autoTable({
                startY: 15,
                tableWidth: 'wrap',
                margin: {
                    left: 155,
                },
                styles: {
                    fillColor: [255, 255, 255],
                    cellPadding: 0.5,
                },
                alternateRowStyles: {
                    fillColor: [255, 255, 255],
                },
                body: [
                    [{
                        content: "N° de facture",
                        colSpan: 2,
                        styles: {
                            fontStyle: 'bold',
                            halign: 'right'
                        }
                    }],
                    [{
                        content: bill.id,
                        colSpan: 2,
                        styles: {
                            fontStyle: 'bold',
                            halign: 'right',
                            textColor: '#1750a0'
                        }
                    }],
                    [{
                        content: "Date d'émission:"
                    }, {
                        content: bill.dateStart,
                        styles: {
                            fontStyle: 'bold',
                        }
                    }],
                    [{
                        content: "Échéance:",
                        styles: {
                            halign: 'right',
                        }
                    }, {
                        content: bill.dateEnd,
                        styles: {
                            fontStyle: 'bold',
                        }
                    }],
                    [{
                        content: "CHE-631.761 TVA",
                        colSpan: 2,
                        styles: {
                            halign: 'right',
                        }

                    }]
                ]
            });

            //numero client
            pdf.autoTable({
                startY: 70,
                margin: {
                    left: 130,
                },
                body: [
                    ['Numéro de client', bill.client.id]
                ],

                columnStyles: {
                    0: {
                        fontStyle: 'bold',
                    },
                    1: {
                        halign: 'right',
                    },
                },
            });

            //tableau principal
            pdf.autoTable({
                startY: 90,
                margin: {
                    left: 22,
                },
                body: getBody(),
                columnStyles: {
                    1: {
                        halign: 'right',
                    },
                    2: {
                        halign: 'center',
                    },
                    3: {
                        halign: 'right',
                    }
                }
            });

            pdf.addPage();

            var string = pdf.output("datauristring");
            $("iframe").attr("src", string);
        });
    </script>
</body>

</html>