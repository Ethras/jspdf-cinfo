<!DOCTYPE html>
<html style="height: 100%;">

<head>
    <title>Parcel Sandbox</title>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/jspdf@1.5.3/dist/jspdf.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.3/dist/jspdf.plugin.autotable.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript" src="roboto-normal.js"></script>
    <script type="text/javascript" src="roboto-italic.js"></script>
    <script type="text/javascript" src="roboto-bold.js"></script>
    <script type="text/javascript" src="roboto-bolditalic.js"></script>
</head>

<body style="height: 100%;">
    <iframe frameborder="1" width="100%" height="100%"></iframe>
    <script>
        $(document).ready(function () {
            var pdf = new jsPDF("p", "mm", "a4");

            /* DATA */
            const TVA = 7.7;
            let totalData = {
                total: 0,
                subTotalSoftware: 0,
                subTotalService: 0
            };

            /* bill data */
            let bill = {
                id: 920030174,
                title: 'Migration messagerie locale vers Microsoft Office 365',
                dateStart: '17.03.2020',
                dateEnd: '16.04.2020',
                hourlyRate: 150,
                client: {
                    id: 216157,
                    name: 'Etude MCE Avocats',
                    street: 'Grand Chêne 1-3',
                    postal: 'case postale 6868',
                    city: '1002 Lausanne'
                },
                lines: [
                    { description: 'Licence BitTitan MigrationWiz', type: 1, price: 20, quantity: 65, total: 1300 },
                    { description: 'Prémigration', type: 2, price: 150, quantity: 28, total: 4200 },
                    { description: 'Migration individuelle des emails', type: 2, price: 112.5, quantity: 65, total: 7312.5 },
                    { description: 'Postmigration', type: 2, price: 150, quantity: 16, total: 2400 }
                ],
                total: 432432
            };

            /* FUNCTIONS */
            //calculate total and subTotal
            function calculateTot() {
                for (let i = 0; i < bill.lines.length; i++) {
                    //total
                    totalData.total += bill.lines[i].price * bill.lines[i].quantity;

                    //subtotal
                    if (bill.lines[i].type == 1) {
                        totalData.subTotalSoftware += bill.lines[i].price * bill.lines[i].quantity;
                    }
                    if (bill.lines[i].type == 2) {
                        totalData.subTotalService += bill.lines[i].price * bill.lines[i].quantity;
                    }

                }
            };

            //generate main data for body
            function generateData(billLineType, data) {
                bill.lines.forEach(i => {
                    if (i.type == billLineType) {
                        data.push([
                            {
                                content: i.description,
                                colSpan: 2,
                                styles: {
                                }
                            },
                            {
                                content: i.price.toFixed(2) + ' CHF',
                                styles: {
                                }
                            },
                            {
                                content: i.quantity.toFixed(2),
                                styles: {
                                }
                            },
                            {
                                content: i.total.toFixed(2) + ' CHF',
                                styles: {
                                }
                            }
                        ]);
                    }
                })
            };

            //main body data
            function getBody() {
                let body = [];

                //header
                body = [
                    //Title
                    [{
                        content: 'Facture - ' + bill.title,
                        colSpan: 5,
                        styles: {
                            halign: 'center',
                            fontStyle: 'bold',
                            //gray box
                            fillColor: [192, 192, 192]
                        }
                    }],
                    //header: gray font
                    ['Article', '', 'Prix unitaire', 'Quantité', 'Montant Total'],
                ]

                //header 1st content
                body.push([{
                    content: 'Logiciel',
                    colSpan: 5,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold',
                        //soft gray box
                        fillColor: [220, 220, 220]
                    }
                }]);
                //1st content
                generateData(1, body);
                //1st subtotal
                body.push([{
                    content: 'Sous total',
                    colSpan: 4,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: totalData.subTotalSoftware.toFixed(2) + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);

                //header 2nd content
                body.push([{
                    content: 'Service',
                    colSpan: 5,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold',
                        //soft gray box
                        fillColor: [220, 220, 220]
                    }
                }]);
                //2nd content
                generateData(2, body);
                //2nd subtotal
                body.push([{
                    content: 'Sous total',
                    colSpan: 4,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: totalData.subTotalService.toFixed(2) + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: 'Facture ' + bill.id + ': ' + bill.title,
                    colSpan: 5,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold',
                        //soft gray box
                        fillColor: [220, 220, 220]
                    }
                }]);
                body.push([{
                    content: '',
                    colSpan: 5
                }]);

                //total box
                body.push([{
                    content: '',
                    colSpan: 3
                },
                {
                    content: 'SOUS-TOTAL',
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: totalData.total.toFixed(2) + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    //yellow box
                    content: 'Tarif horaire hors TVA: ',
                    styles: {
                        halign: 'left',
                        fillColor: [255, 255, 224]
                    }
                },
                {
                    //yellow box
                    content: bill.hourlyRate.toFixed(2) + ' CHF',
                    styles: {
                        halign: 'right',
                        fillColor: [255, 255, 224]
                    }
                },
                {
                    content: ''
                },
                {
                    content: 'TVA ' + TVA + '%',
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: ((totalData.total / 100) * TVA).toFixed(2) + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: '',
                    colSpan: 3
                },
                {
                    content: 'MONTANT TOTAL',
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold'
                    }
                },
                {
                    content: ((totalData.total + (totalData.total / 100) * TVA)).toFixed(2) + ' CHF',
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: '',
                    colSpan: 5
                }]);

                //info box
                body.push([{
                    content: 'Informations',
                    colSpan: 5,
                    styles: {
                        halign: 'center',
                        fontStyle: 'bold',
                        //gray box
                        fillColor: [192, 192, 192]
                    }
                }]);
                body.push([{
                    content: 'Lorem ipsum',
                    colSpan: 5,
                    styles: {
                        halign: 'left',
                        fontStyle: 'bold'
                    }
                }]);
                body.push([{
                    content: 'Lorem ipsum2',
                    colSpan: 5,
                    styles: {
                        halign: 'left'
                    }
                }]);
                body.push([{
                    content: 'Payable à 30 jours net',
                    colSpan: 5,
                    styles: {
                        halign: 'right',
                        fontStyle: 'bold'
                    }
                }]);

                return body
            };

            /* PAGE */
            //set total and subTotal
            calculateTot();

            // Test text - logo?
            pdf.setFontSize(40);
            pdf.text(20, 20, "Hello world");

            //info facture
            pdf.autoTable({
                startY: 15,
                theme: 'plain',
                tableWidth: 'wrap',
                margin: {
                    left: 155,
                },
                styles: {
                    font: 'roboto',
                    cellPadding: 0.5,
                    halign: 'right',
                    /* A supprimer */
                    lineColor: [44, 62, 80],
                    lineWidth: 0.5,
                },
                body: [
                    [{
                        content: "N° de facture",
                        colSpan: 2,
                        styles: {
                            fontStyle: 'bold'
                        }
                    }],
                    [{
                        content: bill.id,
                        colSpan: 2,
                        styles: {
                            fontStyle: 'bold',
                            textColor: '#1750a0'
                        }
                    }],
                    [{
                        content: "Date d'émission:"
                    }, {
                        content: bill.dateStart,
                        styles: {
                            fontStyle: 'bold',
                        }
                    }],
                    [{
                        content: "Échéance:"
                    }, {
                        content: bill.dateEnd,
                        styles: {
                            fontStyle: 'bold',
                        }
                    }],
                    [{
                        content: "CHE-631.761 TVA",
                        colSpan: 2
                    }]
                ]
            });

            // Addresse client
            pdf.autoTable({
                startY: 53,
                theme: 'plain',
                tableWidth: 'wrap',
                margin: {
                    left: 22
                },
                styles: {
                    font: 'roboto',
                    cellPadding: 0.5,
                    /* a supprimer */
                    lineColor: [44, 62, 80],
                    lineWidth: 0.5,
                },
                body: [
                    [{
                        content: 'Adresse du client',
                        styles: {
                            fontStyle: 'bold'
                        }
                    }],
                    [{ content: bill.client.name }],
                    [{ content: bill.client.street }],
                    [{ content: bill.client.postal }],
                    [{ content: bill.client.city }]

                ]
            });


            //numero client
            pdf.autoTable({
                startY: 70,
                theme: 'plain',
                margin: {
                    left: 130,
                },

                styles: {
                    font: 'roboto',
                    /* a supprimer */
                    lineColor: [44, 62, 80],
                    lineWidth: 0.5,
                    //yellow box
                    fillColor: [255, 255, 224]
                },
                columnStyles: {
                    0: {
                        fontStyle: 'bold',
                    },
                    1: {
                        halign: 'right',
                    },
                },
                body: [
                    ['Numéro de client', bill.client.id]
                ]
            });

            //tableau principal
            pdf.autoTable({
                startY: 90,
                margin: {
                    left: 22,
                },
                theme: 'plain',
                styles: {
                    font: 'roboto',
                    /* a supprimer */
                    lineColor: [44, 62, 80],
                    lineWidth: 0.5
                },
                columnStyles: {
                    2: {
                        halign: 'right',
                        cellWidth: 'wrap',
                    },
                    3: {
                        halign: 'center',
                        cellWidth: 'wrap'
                    },
                    4: {
                        halign: 'right',
                        cellWidth: 'wrap'
                    }
                },
                body: getBody()
            });

            pdf.addPage();

            var string = pdf.output("datauristring");
            $("iframe").attr("src", string);
        });
    </script>
</body>

</html>